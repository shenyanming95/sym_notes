# 1.zookeeper简介

Zookeeper是一个开源的为分布式应用提供协调服务的Apache项目，它是一个典型的分布式数据一致性的解决方案。从设计模式的角度看，zookeeper采取的是“观察者模式”：它负责存储和管理数据，然后接受观察者的注册，一旦这些数据的状态发生变化，zookeeper负责通知已经在zookeeper上注册的观察者们

## 1.1.特点

![](C:\Users\Administrator\Desktop\笔记-md\images\zookeeper\zookeeper特点.png)

①一个领导者(Leader)，多个跟随者(Follower)组成的集群；

②集群中只要有半数以上节点存活，集群就能正常服务；

③全局数据一致，每个server节点保存相同的数据副本，client无论连接到哪个server上，数据都是一样的；

④更新请求顺序执行，来自同一个Client的更新请求按其发送顺序依次珍惜；

⑤数据更新原子性，一次数据更新要么成功，要么失败

⑥实时性：在一定时间范围内，client能获取到最新数据

## 1.2.基本概念

### 1.2.1.集群角色

Leader：为客户端提供读和写服务

Follower：提供读服务，参与选举和“过半写成功”策略

Observer：提供读服务，不参与选择和“过半写成功”策略

### 1.2.2.会话(Session)

客户端和服务端之间的TCP长连接，在zookeeper客户端启动时候，就会与zk集群建议一个TCP连接，并与其通过心跳检测保持有效会话

### 1.2.3.数据节点(Znode)

zookeeper中，节点分为两类：第一类是构成集群的机器，称为机器节点；第二类则是数据模型中的数据单元，称为数据节点-Znode。zookeeper的数据模型跟标准的Unix文件系统非常类似，它没有目录和文件等概念，而是引用了一种叫做Znode的数据节点，每个数据都有一个唯一的路径，它自身可以保存数据，也可以挂载子节点。一个zookeeper的视图如下：

![](C:\Users\Administrator\Desktop\笔记-md\images\zookeeper\znode结构.png)

Znode类型可以分为3大类：持久节点(PERSISTENT)、临时节点(EPHEMERAL)、顺序节点(SEQUENTIAL)，具体可以组装成4种节点：

| **节点**     | **功能**                                                     |
| ------------ | :----------------------------------------------------------- |
| 持久节点     | 一旦该数据节点创建后，除非显式删除，否则会一直存在于zookeeper上 |
| 持久顺序节点 | 在持久节点基础上增加顺序性，每个父节点会记录它的第一级子节点创建的先后顺序。zookeeper会自动为给定节点加一个数字后缀，其值上限为整型最大值 |
| 临时节点     | 临时节点的生命周期与客户端会话绑定一起，一旦客户端会话失效(并不是TCP一断开)，临时节点就会被删除，zookeeper规定临时节点只能做叶子结点 |
| 临时顺序节点 | 在临时节点的基础会记录每个一级子节点的创建顺序，为它们编号   |

### 1.2.4.状态(Stat)

每个Znode除了保存用户的数据外，还会保存当前数据节点的所有状态信息，包括事务ID、版本信息和子节点个数等等，这个状态信息称为Stat。它具有如下的属性：

| **状态属性**   | **说明**                                                     |
| -------------- | ------------------------------------------------------------ |
| czxid          | 即Created ZXID，表示该数据节点被创建时的事务ID               |
| mzxid          | 即Modified ZXID，表示该数据节点最后一次被更新时的事务ID      |
| ctime          | 即Craeted Time，表示节点被创建的时间                         |
| mtime          | 即Modified Time，表示该节点最后一次被更新的时间              |
| version        | 数据节点的版本号                                             |
| cversion       | 子节点的版本号                                               |
| aversion       | 节点的ACL版本号                                              |
| ephemeralowner | 创建该临时节点的客户端会话的sessionID，如果该节点是持久节点，那么属性值为0 |
| dataLength     | 数据内容的长度                                               |
| numChildren    | 当前节点的子节点个数                                         |
| pzxid          | 表示该节点的子节点列表最后一次被修改时的事务ID。只有子节点列表变更了才会变更pzxid，子节点内容变更不会影响pzxid |

### 1.2.5.版本(Version)

当一个Znode被创建出来，它的version值为0，表示未被修改过；后续如果有客户端来修改，它的version就会累加1(即使这次修改操作没有改变Znode的数据内容，它的version也会累加1，强调的是修改次数)

### 1.2.6.事务(ZXID)

在zookeeper中，事务是指能够改变zookeeper服务器状态的操作，一般指：数据节点创建于删除、数据节点内容更新、客户端会话创建与失效等，对于每一个事务请求，zookeeper都会为其分配一个全局唯一的事务ID，称为ZXID

### 1.2.7.监听器(Watcher)

事件监听器，客户端可以在Znode上注册一些watcher，当相应的事件发生时，zookeeper服务端就会将事件通知给客户端

### 1.2.8.权限(ACL)

Access Control Lists，zookeeper采用ACL策略进行权限控制，并定义了以下5个权限：

①Create：创建子节点的权限；

②read：获取节点数据和子节点列表的权限

③write：更新节点数据的权限

④delete：删除子节点的权限

⑤admin：设置ACL的权限

## 1.3.分布式特性