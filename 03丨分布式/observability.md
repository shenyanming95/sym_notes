## 1.什么是可观测性

可观测性：是系统可由其外部输出推断其内部状态的变化。一个系统具备可观测性当且仅当：针对所有状态向量和控制项链，都可以在有限时间内，只根据其输出信号来识别目前的状态。

## 2.可观测性的提出

20世纪70年代鲁道夫.卡尔曼（现代控制理论之父）系统性地提出了可观测性理论（Oberservability）

- 外部输出、内部状态和有限时间概念：这个定义比较抽象，其中的关键信息为：**外部输出**，**内部状态**和**有限时间**。外部输出可以让我们低成本观测系统状态，内部状态明确系统内部具体状况从而针对性治理问题，有限时间则表面可观测必须在有限时间内有效否则将失去观测的意义。
- 例子说明：去医院做体检，医院抽到的尿液是外部输出，内部状态是肾脏是否有毛病，有限时间需要再一周内给出报告。所以这三者都很关键：如果没有外部输出就需要用探头或者开刀检查了，代价高，效率低；如果没有内部状态，那么就无法判断应该进行何种治疗；如果不是有限时间，那么病情要恶化。

## 3.监控和可观测性的关系

在 2018 年以前， IT 领域一直使用监控这个术语，来表示通过采集系统、服务和网络的内部信息，诊断和预测系统的行为。到了 2018 年， CNCF Landscape 率先出现了 Observability 的概念，将可观测性（ Observability ）从控制论（ Cybernetics ）中引入到 IT 领域。

一般来说，监控主要告诉我们以下的信息，这些信息主要表现为结果：

- CPU超过80%
- 系统负载超过200%
- 机器宕机了，服务崩溃了

而一个可观测系统，除了告诉我们这些结果信息之外，还需要能回答出导致这些结果的原因。

- 性能问题是由什么原因导致的？瓶颈在哪里？
- 请求执行过程都需要经过那些服务？请求失败的原因是什么？
- 每个服务如何处理请求？服务之间的依赖关系是什么样的？

在 IT 建设中，我们将“可观测性”能力划分为 5 个层级，其中告警（ Alerting ）与应用概览（ Overview ）都属于传统监控的概念范畴，因为触发告警的往往是明显的症状与表象。**但在云原生时代，架构与应用部署方式的变化是非常频繁的，不告警并非意味着一切正常，因此，通过获取系统内部的信息，来主动发现（ Preactive ）问题就显得非常重要了**。

![](https://static001.geekbang.org/resource/image/d3/5a/d3653906bce29ba2f44f50aae03f855a.jpg?wh=2284x1861)

可观测性通过排错、剖析与依赖分析，这三个部分来主动发现故障，具体如下。

- 排错（ Debugging ），即运用数据和信息去诊断故障出现的原因。
- 剖析（ Profiling ），即运用数据和信息进行性能分析。
- 依赖分析（ Dependency Analysis ），即运用数据信息追踪系统模块的依赖关系，进行关联分析。

## 4.MLT理论

2017年的分布式追踪峰会结束后，Peter Bourgon撰写了以**Metrics**、**Tracing**和**Logging（以下简称：MTL）**为核心的可观测性三个具体方向，目前在计算机领域受到了业界广泛认可，这三者并称为可观测性三大支柱。逐渐衍生为以MTL为核心的理论体系。

![](./images/可观测性-MLT理论.png)

- **指标**（Metrics）

  指标是指对系统中某一类信息的统计聚合。度量的主要目的是监控（Monitoring）和预警（Alert），如某些指标指标达到风险阈值时触发事件，以便自动处理或者提醒管理员介入。

- **日志**（Logging）

  日志的职责是记录离散事件，通过这些记录事后分析出程序的行为。比如调用了什么方法，状态如何，当前事件的上下文等信息。

- **追踪**（Tracing）：

  记录单个，其中包括服务调用和处理时长等信息。追踪的主要记录单次请求的处理流程，目的是排查故障，如分析调用链的哪一部分、哪个方法出现错误或阻塞，输入输出是否符合预期，等等。

  微服务时代，由于分布式的跨服务调用情况下，不能只局限在调用栈了。需要包括服务间的网络传输信息与各个服务内部的调用堆栈信息。因此，分布式系统中的追踪在国内常被称为“全链路追踪”。

## 5.美团内部实现

1. **Metrics**
   - [Raptor](https://raptor.mws.sankuai.com/client/perf/trend?start=20220517162900&end=20220517172900&timeType=datetimerange)是面向基础设施和端到端应用程序的监控平台。Raptor主要侧重于移动端、浏览器端、应用层、系统层以及网络层的指标采集、计算、存储、展示以及告警。
   - [Perf](https://perf.sankuai.com/#/crash/new/overview/index?project=android-nova&type=crash) 平台整合了现有Native端、多种动态化容器以及windows桌面应用的监控，指标建设上故障类、性能类、网络、路由、线上舆情等多种影响用户体验的指标；功能上支持指标查询、对比、故障&性能问题定位分析、实时数据监控报警的能力。
2. **Tracing**
   - [Mtrace](https://km.sankuai.com/page/203528130)分布式链路追踪系统，主要用于分析分布式系统的行为，解决系统间的调用瓶颈，监控各个服务的运行状态，采集业务敏感的相关数据。
   - [Ocean](https://km.sankuai.com/page/441011412)是由基础研发平台/公共数据与产品服务中心/流量产品组提供的面向全公司业务使用的一站式流量管理与分析平台。业务通过接入灵犀SDK和使用Ocean，完成对用户行为数据的采集、管理和分析。
3. **Logging**
   -  [Logan](https://sc.sankuai.com/#/wheel/homepage?id=4639&channelName=km_card) 是面向终端的统一日志服务，已支持 iOS、Android、Web、小程序、IoT、MRN、Flutter 等多种终端环境，不仅提供了基础的日志采集、存储、上报、回捞、查询与分析的能力，还提供了一系列的日志解决方案，例如全链路日志解决方案、IoT日志解决方案、实时日志解决方案和场景化日志解决方案等。在个案场景下，Logan 的目标是帮助用户快速定位问题，提升故障排查效率；在通用场景下，Logan 的目标是提升日志利用率，发掘日志数据潜在价值。